#!/usr/bin/env bash

lastHeader=''
optAll=0
if [[ "$1" == "--all" ]]
then
	optAll=1
fi

while read -r json
do
	packageName="$(echo "$json" | jq -r '.packageName')"
	packageName="$(echo "$packageName" | perl -pe 's/^((org|com|android|samsung|google|apps|schabi|app|mobi|de|danoeh|app|sec)\.)+//g')"
	packageName="$(echo "$packageName" | perl -pe 's/^(facebook.orca)$/messenger/g')"
	packageName="$(echo "$packageName" | perl -pe 's/^(zhiliaoapp.musically)$/tiktok/g')"

	packageName="$(echo "$packageName" | perl -pe 's/(\.(orca|android|frontpage|application|mShop|shopping|katana|music))+$//g')"

	title="$(echo "$json" | jq -r '.title')"
	content="$(echo "$json" | jq -r '.content')"

	if [[ "${packageName,,}" == "${title,,}" ]]
	then
		title=''
	fi

	# skip these no matter what
	if [[ "$packageName" =~ ^(termux|spotify|aimp.player|newpipe|smartcapture|antennapod|systemui|samsungapps)$ ]]
	then
		continue
	# skip these unless passed --all
	# things you might want to check once
	elif [[ "$optAll" == 0 ]] && [[ "$packageName" =~ ^(termux.api|reddit|patreon|facebook|lool|tiktok)$ ]]
	then
		continue
	elif [[ "$optAll" == 0 ]] && [[ "$packageName" == "discord" ]] && [[ "$title" == *#memes* && "${content}" =~ \.(jpe?g|png)$ ]]
	then
		continue
	elif [[ "$optAll" == 0 ]] && [[ "$packageName" == "snapchat" ]] && [[ "${title,,}" == 'video for'* ]] && [[ "${content,,}" == *'added a video to spotlight!' ]]
	then
		continue
	elif [[ "$optAll" == 0 ]] && [[ "$packageName" == "instagram" ]] && [[ "${content,,}" == *'who you might know, is on instagram'* ]]
	then
		continue
	elif [[ "$optAll" == 0 ]] && [[ "$packageName" == "youtube" ]] && [[ "${content,,}" == 'for you:'* ]]
	then
		continue
	elif [[ "$optAll" == 0 ]] && [[ "$packageName" == "nextdoor" ]] && [[ "${title,,}" == *'reposted'* ]]
	then
		continue
	elif [[ -z "$title" && -z "$content" ]]
	then
		continue
	fi

	# app specific tweaks
	if [[ "${packageName,,}" == "facebook" ]]
	then
		acct="$title"
		title=""
		if [[ "$content" != *"$acct"* ]]
		then
			content="$acct: $content"
		fi
	elif [[ "${packageName,,}" == "messaging" ]] && [[ "$title" == *,* ]]
	then
		mostCommonWord="$(echo "$title" | grep -iPo '\b\w+\b' | sort | uniq -ci | sort -h | tail -n1 | sed 's/^ *[0-9]* //g')"
		
		title="$mostCommonWord group"
	fi
	
	header="$packageName: $title"
	if [[ "$header" != "$lastHeader" ]]
	then
		output+=$'\n'
		output+="--------"$'\n'
		output+=$'\n'
		output+="$header"$'\n'

		lastHeader="$header"
	fi

	output+="$content"$'\n'
	
done < <( termux-notification-list | jq 'sort_by(.when)' | jq -rc '.[]' ) 

echo "$output" | perl -0777pe 's/(^[\s-]+|[\s-]+$)//g' | less --quit-if-one-screen

