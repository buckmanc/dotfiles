#!/usr/bin/env bash

set -e

searchArg="$1"

# default macropad
if [[ -z "$searchArg" ]]
then
	searchArg="4x3"
fi

# find the appropriate config file
configPath="$(find "$HOME/.config" -type f -iname '*ch57x*.yaml' -iname "*$searchArg*" -print -quit)"

if [[ ! -f "$configPath" ]]
then
	echo "could not find config path"
	exit 1
fi

# edit
vim "$configPath"

# validate and update
if ch57x-keyboard-tool validate "$configPath"
then
	output="$(ch57x-keyboard-tool upload "$configPath" 2>&1 || true)"

	# sudo try again
	if [[ "${output,,}" == *"insufficient permissions"* ]]
	then
		output="$(sudo "$(which ch57x-keyboard-tool)" upload "$configPath" 2>&1 || true)"
	fi

	if [[ "${output,,}" == *"error: find usb device"* ]]
	then
		echo 'macropad not detected ğŸ‘'
		exit 1
	elif [[ -n "$output" ]]
	then
		# echo "output: $output"
		echo "$output"
	else
		# thumbs up to match validation message
		echo 'updated ğŸ‘'
	fi
fi
