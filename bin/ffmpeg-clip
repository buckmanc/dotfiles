#!/usr/bin/env bash

set -e

optTitle=0
optNoSnap=0
args=()

for arg in "$@"
do
	if [[ -f "$arg" ]]
	then
		inputFile="$arg"
	elif [[ "$arg" == "-t" || "$arg" == "--title" ]]
	then
		optTitle=1
	elif [[ "$arg" == "--no-snap" ]]
	then
		optNoSnap=1
	elif [[ "$arg" =~ [0-9]:[0-9] ]]
	then
		args+=("$arg")
	else
		echo "I have no idea what $arg means"
		exit 1
	fi
done

if [[ -z "$inputFile" ]]
then
	echo "need input path"
	exit 1
fi

echo "got ${#args[@]} timestamps"

inputExt="${inputFile##*.}"
fileNameNoExt="$(basename "$inputFile")"
fileNameNoExt="${fileNameNoExt%.*}"
inputFileDir="$(dirname "$inputFile")"
tempDir="$TEMP/$inputFile"
clipSnapsDir="$inputFileDir/clip snaps"
totalSeconds="$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$inputFile")"

if type magick > /dev/null 2>&1
then
	magick="magick"
else
	magick="convert"
fi

mkdir -p "$tempDir"

if [[ "$optNoSnap" == 0 ]]
then
	mkdir -p "$clipSnapsDir"
fi

i=0

clip(){
	i=$((i+1))
	id="$(printf "%03d" "$i")"
	start="$1"
	fin="$2"

	outPath="$inputFileDir/${fileNameNoExt}_$id.$inputExt"
	snapPath="$clipSnapsDir/${fileNameNoExt}_${id}_$(echo "$start" | perl -pe 's/[:\.]/_/g')_to_$(echo "$fin" | perl -pe 's/[:\.]/_/g').png"

	echo -n "clip $id"

	if [[ -f "$outPath" ]]
	then
		echo -n " already exists"
	else
		titleArgs=()
		if [[ "$optTitle" == 1 ]]
		then
			titleArgs+=(-vf "drawtext=${HOME}/.termux/font.ttf:text='part ${id##0}':fontcolor=white:fontsize=(w/7):box=1:boxcolor=black@0.5:boxborderw=5:x=w-tw:y=h-th")
		else
			titleArgs+=(-c:v copy)
		fi

		# clip
		ffmpeg -loglevel warning -n -i "$inputFile" -ss "$start" -to "$fin" -c:a copy "${titleArgs[@]}" "$outPath"

		if [[ "$optNoSnap" == 0 ]]
		then
			# calc frames
			totalFrames="$(ffprobe -v error -count_frames -select_streams v:0 -show_entries stream=nb_read_frames -of csv=p=0 "$outPath" | perl -pe 's/,$//g')"
			midFrame=$((totalFrames/2))

			# snap start, middle, end
			ffmpeg -y -loglevel error -i "$outPath" -ss "0" -vframes 1 -y -loglevel error "$tempDir/first.png" -y
			ffmpeg -y -loglevel error -i "$outPath" -vf select=\'eq\(n,"$midFrame"\) -vframes 1 "$tempDir/mid.png"
			ffmpeg -y -loglevel error -sseof -3 -i "$outPath" -update true "$tempDir/last.png" -y

			"$magick" "$tempDir/first.png" -resize 50% "$tempDir/first.png"
			"$magick" "$tempDir/mid.png"   -resize 50% "$tempDir/mid.png"
			"$magick" "$tempDir/last.png"  -resize 50% "$tempDir/last.png"

			# combine to one final snap
			"$magick" "$tempDir/first.png" "$tempDir/mid.png" "$tempDir/last.png" -append "$snapPath"
		fi
	fi

	echo
}

# echo "totalSeconds: $totalSeconds"

lastArg=0
for arg in "${args[@]}"
do
	adjStamp="$arg"
	while ! echo "$adjStamp" | grep -Piq '(\d+:){2}'
	do
		adjStamp="00:${adjStamp}"
	done

	# will break if video is gt 24 hours
	clipSeconds="$(date --utc --date "1970-01-01 $adjStamp" +%s)"
	greaterThanTotal="$(echo "$clipSeconds > $totalSeconds" | bc -l)"

	# echo "arg: $arg"
	# echo "adjStamp: $adjStamp"
	# echo "clipSeconds: $clipSeconds"
	# echo "greaterThanTotal: $greaterThanTotal"

	if [[ "$greaterThanTotal" == 1 ]]
	then
		echo "timestamp greaters than length of clip, skipping"
		break
	fi

	# do work
	clip "$lastArg" "$arg"

	lastArg="$arg"
done

clip "$lastArg" 9999.99
