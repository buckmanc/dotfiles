#!/usr/bin/env bash

cacheDir="$HOME/.cache/play-dungeon-synth"
maxFiles=24
maxFilesPlusOne=((maxFiles+1))
vlcPath="$PROGRAMFILES/VideoLAN/VLC/vlc.exe"
outputFormat="%(n_entries+1-playlist_index)0d_%(title)s"
playlistPath="$cacheDir/Dungeon Synth Archives.m3u"

mkdir -p "$cacheDir"

# download the x most recent videos
yt-dlp 'https://www.youtube.com/@TheDungeonSynthArchives/videos' --extract-audio --embed-metadata --embed-thumbnail --break-on-existing --audio-format "mp3" --audio-quality 1 --output "$cacheDir/$outputFormat.%(ext)s" --download-archive "$cacheDir/archive.log" --max-downloads "$maxFiles" --restrict-filenames --no-overwrites --print "$outputFormat" --no-simulate

# remove files beyond the max
ls -t "$cacheDir/*.mp3" | tail -n +"$maxFilesPlusOne" | xargs --delimiter '\n' --no-run-if-empty rm

# build the playlist in windows path format, files in descending order
files="$(find "$cacheDir" -type f -iname '*.mp3' | sort -r | xargs --delimiter $'\n' cygpath --windows)"
echo "$files" > "$playlistPath"

# start vlc
start "" "$vlcPath" "$(cygpath --windows "$playlistPath")"


