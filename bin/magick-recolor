#!/usr/bin/env bash

set -e

files=()
colorPool=()
for arg in "$@"
do
	if [[ "$arg" == "-"* ]]
	then
		echo "I have no idea what $arg means"
		exit 1
	elif [[ -f "$arg" ]]
	then
		files+=("$arg")
	else
		colorPool+=("$arg")
	fi
done

colorPool+=("red" "blue" "darkgrey" "lightgreen" "orange" "pink")

for path in "${files[@]}"
do
	if [[ -z "$path" || ! -f "$path" ]]
	then
		continue
	fi

	colorReport="$(magick "$path" -format '%c' histogram:info: | sort -hr)"
	hexCodes="$(echo "$colorReport" | grep -iPo '#[^ ]{6}(?= )')"
	probBgHexCode="$(magick "$path" -format "#%[hex:u.p{0,0}]" info:)"

	# this one is stupid wrong
	# darkestHexCode="$(magick "$path" -colorspace HSL -format "%c" histogram:info: | sort -nk 3 | head -n 1 | grep -iPo '#[^ ]{6}')"

	darkestHexCode="#FFFFFF"
	while read -r hexCode
	do
		if ((
			(0x${hexCode:1:2} + 0x${hexCode:3:2} + 0x${hexCode:5:2}) <
			(0x${darkestHexCode:1:2} + 0x${darkestHexCode:3:2} + 0x${darkestHexCode:5:2})
			))
		then
			darkestHexCode="$hexCode"
		fi
	done < <( echo "$hexCodes" )

	colorReport="$(echo "$colorReport" | \
		sed "/$probBgHexCode/s/$/ # bg?/" | \
		sed "/$darkestHexCode/s/$/ # darkest/" | \
		perl -pe 's/ srgb\([\d, ]+\)//g' | \
		perl -pe 's/,/, /g' | \
		column --table --output-separator " ")"

	fullFileName="$(basename "$path")"
	destDir="$(dirname "$path")"
	fileName="${fullFileName%.*}"
	# fileExt="${fullFileName##*.}"
	destPath="$destDir/${fileName}_recolor.png"
	destTestPath="$destDir/${fileName}_recolor_enlarged.png"

	echo
	echo "$fullFileName"
	echo "$colorReport"

	recolorCmd=()
	recolorCmd+=("magick '$path'")

	iHex=0
	while read -r hexCode
	do
		# if [[ "$hexCode" == "$probBgHexCode" ]]
		if [[ 1 == 2 ]]
		then
			# destColor="transparent"
			destColor="pink"
		else
			destColor="${colorPool[iHex]}"
			iHex=$((iHex + 1))
		fi

		recolorCmd+=("-fill '$destColor' -opaque '$hexCode'")

	done < <(echo "$hexCodes")

	recolorCmd+=("'$destPath'")

	eval "${recolorCmd[*]}"
	magick "$destPath" -interpolate integer -filter point -resize "1000x1000^<" "$destTestPath"

	if (type termux-media-scan > /dev/null 2>&1 )
	then
		termux-media-scan "$destDir" > /dev/null
	fi
done
